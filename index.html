from flask import Flask, jsonify, request, render_template
from flask_cors import CORS
import random
import logging

app = Flask(__name__)
CORS(app)

# Настройка логирования
logging.basicConfig(level=logging.INFO)

# Инициализация данных игры
players = {}  # Словарь для хранения данных игроков
board = [
    {"name": "Старт", "owner": None, "houses": 0, "price": 0, "type": "start"},
    {"name": "Улица 1", "owner": None, "houses": 0, "price": 200, "type": "property"},
    {"name": "Улица 2", "owner": None, "houses": 0, "price": 200, "type": "property"},
    {"name": "Тюрьма", "owner": None, "houses": 0, "price": 0, "type": "jail"},
    {"name": "Улица 3", "owner": None, "houses": 0, "price": 300, "type": "property"},
    {"name": "Улица 4", "owner": None, "houses": 0, "price": 300, "type": "property"},
]

# Создание игрока
def create_player(player_id):
    players[player_id] = {
        "money": 1500,
        "position": 0,
        "properties": [],
        "in_jail": False,
        "jail_turns": 0,
    }

# Главная страница
@app.route('/')
def index():
    return render_template('index.html')  # Рендеринг HTML-файла

# Получить статус игры
@app.route('/game-status/<player_id>', methods=['GET'])
def game_status(player_id):
    if player_id not in players:
        create_player(player_id)
    return jsonify({
        "player": players[player_id],
        "board": board,
    })

# Бросок кубика
@app.route('/roll-dice/<player_id>', methods=['POST'])
def roll_dice(player_id):
    dice = random.randint(1, 6)
    player = players[player_id]
    
    if player["in_jail"]:
        player["jail_turns"] += 1
        if player["jail_turns"] >= 3:
            player["in_jail"] = False
            player["jail_turns"] = 0
            message = "Вы вышли из тюрьмы!"
        else:
            message = "Вы остаетесь в тюрьме."
        return jsonify({"message": message})
    
    player["position"] = (player["position"] + dice) % len(board)
    cell = board[player["position"]]

    # Обработка событий на клетке
    if cell["type"] == "jail":
        player["in_jail"] = True
        message = "Вы попали в тюрьму!"
    elif cell["type"] == "property" and cell["owner"] is not None and cell["owner"] != player_id:
        rent = cell["price"] * 0.1  # Арендная плата
        player["money"] -= rent
        players[cell["owner"]]["money"] += rent
        message = f"Вы заплатили аренду: {rent}$"
    else:
        message = f"Вы попали на клетку: {cell['name']}"

    return jsonify({
        "dice": dice,
        "cell": cell["name"],
        "message": message,
    })

# Покупка клетки
@app.route('/buy-property/<player_id>', methods=['POST'])
def buy_property(player_id):
    player = players[player_id]
    cell = board[player["position"]]
    if cell["type"] == "property" and cell["owner"] is None and player["money"] >= cell["price"]:
        cell["owner"] = player_id
        player["money"] -= cell["price"]
        player["properties"].append(cell["name"])
        return jsonify({"message": f"Клетка '{cell['name']}' куплена!"})
    else:
        return jsonify({"message": "Покупка невозможна."})

# Постройка дома
@app.route('/build-house/<player_id>', methods=['POST'])
def build_house(player_id):
    player = players[player_id]
    cell = board[player["position"]]
    if cell["owner"] == player_id and player["money"] >= 100:
        cell["houses"] += 1
        player["money"] -= 100
        return jsonify({"message": "Дом построен!"})
    else:
        return jsonify({"message": "Постройка невозможна."})

# Торговля
@app.route('/trade/<player_id>', methods=['POST'])
def trade(player_id):
    data = request.json
    target_player_id = data["target_player"]
    property_offer = data["property_offer"]
    property_request = data["property_request"]

    player = players[player_id]
    target_player = players[target_player_id]

    if property_offer in player["properties"] and property_request in target_player["properties"]:
        player["properties"].remove(property_offer)
        target_player["properties"].append(property_offer)
        target_player["properties"].remove(property_request)
        player["properties"].append(property_request)
        return jsonify({"message": "Обмен успешен!"})
    else:
        return jsonify({"message": "Обмен невозможен."})

# Запуск сервера
if __name__ == '__main__':
    app.run(debug=True)
